{"version":3,"file":"index.js","sources":["../src/stream.js"],"sourcesContent":["import {useCallback, useEffect, useRef} from 'react';\n\n/**\n * @typedef {object} StreamHook\n * @property {function()} close - Close the stream\n */\n\n/**\n * React hook for the [Streams API](https://developer.mozilla.org/en-US/docs/Web/API/Streams_API).\n * Use this hook to stream data from a URL.\n * @param {string} url\n * @param {object} [params]\n * @param {function(Response)} [params.onNext]\n * @param {function(Error)} [params.onError]\n * @param {function()} [params.onDone]\n * @param {RequestInit} [params.fetchParams]\n *\n * @returns {StreamHook}\n */\nexport function useStream(url, params) {\n  if (typeof params !== 'object' || params === null) {\n    params = {};\n  }\n\n  const streamRef = useRef();\n  const onNext = useRef(params.onNext);\n  const onError = useRef(params.onError);\n  const onDone = useRef(params.onDone);\n\n  const close = useCallback(() => {\n    if (streamRef.current) {\n      streamRef.current.abort();\n    }\n  }, []);\n\n  useEffect(() => {\n    if (streamRef.current) {\n      streamRef.current.abort();\n    }\n    streamRef.current = new AbortController();\n    startStream(url, {\n      onNext: onNext,\n      onError: onError,\n      onDone: onDone,\n      fetchParams: {\n        ...params.fetchParams,\n        signal: streamRef.current.signal\n      }\n    });\n  }, [url, params.fetchParams]);\n\n  useEffect(() => {\n    onNext.current = params.onNext;\n  }, [params.onNext]);\n\n  useEffect(() => {\n    onError.current = params.onError;\n  }, [params.onError]);\n\n  useEffect(() => {\n    onDone.current = params.onDone;\n  }, [params.onDone]);\n\n  return {close};\n}\n\n/**\n * Use this function to start streaming data from an URL\n * @param {string} url\n * @param {object} params\n * @param {React.MutableRefObject<function(Response)>} params.onNext\n * @param {React.MutableRefObject<function(Error)>} params.onError\n * @param {React.MutableRefObject<function()>} params.onDone\n * @param {RequestInit} params.fetchParams\n */\nasync function startStream(url, {onNext, onError, onDone, fetchParams}) {\n  const errCb = err => {\n    if (typeof onError.current === 'function') {\n      onError.current(err);\n    }\n  };\n\n  try {\n    const res = await fetch(url, {\n      ...fetchParams,\n      method: 'GET'\n    });\n\n    const reader = res.body.getReader();\n\n    if (fetchParams.signal instanceof AbortSignal) {\n      fetchParams.signal.addEventListener('abort', evt => reader.cancel(evt), {\n        once: true,\n        passive: true\n      });\n    }\n\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      try {\n        const {done, value} = await reader.read();\n        if (done) {\n          if (typeof onDone.current === 'function') {\n            onDone.current();\n          }\n          return;\n        }\n\n        const res = new Response(value);\n        if (typeof onNext.current === 'function') {\n          onNext.current(res);\n        }\n      } catch (e) {\n        errCb(e);\n        return;\n      }\n    }\n  } catch (e) {\n    errCb(e);\n  }\n}\n"],"names":["useStream","url","params","streamRef","useRef","onNext","onError","onDone","close","useCallback","current","abort","useEffect","AbortController","startStream","fetchParams","signal","errCb","err","res","fetch","method","reader","body","getReader","AbortSignal","addEventListener","evt","cancel","once","passive","done","value","read","Response","e"],"mappings":"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"}