{"version":3,"file":"index.min.js","sources":["../src/stream.js"],"sourcesContent":["import {useCallback, useEffect, useRef} from 'react';\n\n/**\n * @typedef {object} StreamHook\n * @property {function()} close - Close the stream\n */\n\n/**\n * React hook for the [Streams API](https://developer.mozilla.org/en-US/docs/Web/API/Streams_API).\n * Use this hook to stream data from a URL.\n * @param {string} url\n * @param {object} [params]\n * @param {function(Response)} [params.onNext]\n * @param {function(Error)} [params.onError]\n * @param {function()} [params.onDone]\n * @param {RequestInit} [params.fetchParams]\n *\n * @returns {StreamHook}\n */\nexport function useStream(url, params) {\n  if (typeof params !== 'object' || params === null) {\n    params = {};\n  }\n\n  const streamRef = useRef();\n  const onNext = useRef(params.onNext);\n  const onError = useRef(params.onError);\n  const onDone = useRef(params.onDone);\n\n  const close = useCallback(() => {\n    if (streamRef.current) {\n      streamRef.current.abort();\n    }\n  }, []);\n\n  useEffect(() => {\n    if (streamRef.current) {\n      streamRef.current.abort();\n    }\n    streamRef.current = new AbortController();\n    startStream(url, {\n      onNext: onNext,\n      onError: onError,\n      onDone: onDone,\n      fetchParams: {\n        ...params.fetchParams,\n        signal: streamRef.current.signal\n      }\n    });\n  }, [url, params.fetchParams]);\n\n  useEffect(() => {\n    onNext.current = params.onNext;\n  }, [params.onNext]);\n\n  useEffect(() => {\n    onError.current = params.onError;\n  }, [params.onError]);\n\n  useEffect(() => {\n    onDone.current = params.onDone;\n  }, [params.onDone]);\n\n  return {close};\n}\n\n/**\n * Use this function to start streaming data from an URL\n * @param {string} url\n * @param {object} params\n * @param {React.MutableRefObject<function(Response)>} params.onNext\n * @param {React.MutableRefObject<function(Error)>} params.onError\n * @param {React.MutableRefObject<function()>} params.onDone\n * @param {RequestInit} params.fetchParams\n */\nasync function startStream(url, {onNext, onError, onDone, fetchParams}) {\n  const errCb = err => {\n    if (typeof onError.current === 'function') {\n      onError.current(err);\n    }\n  };\n\n  try {\n    const res = await fetch(url, {\n      ...fetchParams,\n      method: 'GET'\n    });\n\n    const reader = res.body.getReader();\n\n    if (fetchParams.signal instanceof AbortSignal) {\n      fetchParams.signal.addEventListener('abort', evt => reader.cancel(evt), {\n        once: true,\n        passive: true\n      });\n    }\n\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      try {\n        const {done, value} = await reader.read();\n        if (done) {\n          if (typeof onDone.current === 'function') {\n            onDone.current();\n          }\n          return;\n        }\n\n        const res = new Response(value);\n        if (typeof onNext.current === 'function') {\n          onNext.current(res);\n        }\n      } catch (e) {\n        errCb(e);\n        return;\n      }\n    }\n  } catch (e) {\n    errCb(e);\n  }\n}\n"],"names":["url","params","streamRef","useRef","onNext","onError","onDone","close","useCallback","current","abort","useEffect","AbortController","async","fetchParams","errCb","err","reader","fetch","method","body","getReader","signal","AbortSignal","addEventListener","evt","cancel","once","passive","done","value","read","res","Response","e","startStream"],"mappings":"wSAmBO,SAAmBA,EAAKC,GACP,iBAAXA,GAAkC,OAAXA,IAChCA,EAAS,UAGLC,EAAYC,WACZC,EAASD,SAAOF,EAAOG,QACvBC,EAAUF,SAAOF,EAAOI,SACxBC,EAASH,SAAOF,EAAOK,QAEvBC,EAAQC,eAAY,KACpBN,EAAUO,SACZP,EAAUO,QAAQC,UAEnB,WAEHC,aAAU,KACJT,EAAUO,SACZP,EAAUO,QAAQC,QAEpBR,EAAUO,QAAU,IAAIG,gBAoC5BC,eAA2Bb,GAAKI,OAACA,EAADC,QAASA,EAATC,OAAkBA,EAAlBQ,YAA0BA,UAClDC,EAAQC,IACmB,mBAApBX,EAAQI,SACjBJ,EAAQI,QAAQO,cAUZC,SALYC,MAAMlB,EAAK,IACxBc,EACHK,OAAQ,SAGSC,KAAKC,gBAEpBP,EAAYQ,kBAAkBC,aAChCT,EAAYQ,OAAOE,iBAAiB,SAASC,GAAOR,EAAOS,OAAOD,IAAM,CACtEE,MAAM,EACNC,SAAS,gBAOHC,KAACA,EAADC,MAAOA,SAAeb,EAAOc,UAC/BF,cAC4B,mBAAnBvB,EAAOG,SAChBH,EAAOG,iBAKLuB,EAAM,IAAIC,SAASH,GACK,mBAAnB1B,EAAOK,SAChBL,EAAOK,QAAQuB,GAEjB,MAAOE,eACPnB,EAAMmB,IAIV,MAAOA,GACPnB,EAAMmB,IA9ENC,CAAYnC,EAAK,CACfI,OAAQA,EACRC,QAASA,EACTC,OAAQA,EACRQ,YAAa,IACRb,EAAOa,YACVQ,OAAQpB,EAAUO,QAAQa,YAG7B,CAACtB,EAAKC,EAAOa,cAEhBH,aAAU,KACRP,EAAOK,QAAUR,EAAOG,SACvB,CAACH,EAAOG,SAEXO,aAAU,KACRN,EAAQI,QAAUR,EAAOI,UACxB,CAACJ,EAAOI,UAEXM,aAAU,KACRL,EAAOG,QAAUR,EAAOK,SACvB,CAACL,EAAOK,SAEJ,CAACC,MAAAA"}